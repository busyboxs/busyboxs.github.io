<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>通过分析实例来理解TFRecord数据的读取与写入 | Busyboxs</title><meta name="keywords" content="tensorflow"><meta name="author" content="Busyboxs"><meta name="copyright" content="Busyboxs"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文主要通过两个实例来加强对TFRecord数据的理解，分别为目标检测算法SSD和语义分割算法deeplab。仅作为学习笔记以便后续查阅。  TFRecord简介TFRecords文件表示字符串序列（二进制文件）。其格式不是随机访问的，因此它适用于流式传输大量数据，但如果需要快速分片或其他非顺序访问则不适用。 TFRecords文件包含CRC32C（使用Castagnoli多项式的32位CRC）">
<meta property="og:type" content="article">
<meta property="og:title" content="通过分析实例来理解TFRecord数据的读取与写入">
<meta property="og:url" content="https://busyboxs.github.io/blogs/97eeec88/index.html">
<meta property="og:site_name" content="Busyboxs">
<meta property="og:description" content="本文主要通过两个实例来加强对TFRecord数据的理解，分别为目标检测算法SSD和语义分割算法deeplab。仅作为学习笔记以便后续查阅。  TFRecord简介TFRecords文件表示字符串序列（二进制文件）。其格式不是随机访问的，因此它适用于流式传输大量数据，但如果需要快速分片或其他非顺序访问则不适用。 TFRecords文件包含CRC32C（使用Castagnoli多项式的32位CRC）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg">
<meta property="article:published_time" content="2018-09-04T04:00:00.000Z">
<meta property="article:modified_time" content="2019-08-13T02:44:16.627Z">
<meta property="article:author" content="Busyboxs">
<meta property="article:tag" content="tensorflow">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://busyboxs.github.io/blogs/97eeec88/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google_site_verification" content="FwkuU16DW0uUtLvBlI63aK9-eCBhC55pVQMscORY34M"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?0737f86b9c26e7c4269a4dec38cea0c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-158970947-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-158970947-1');
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lacquer&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '通过分析实例来理解TFRecord数据的读取与写入',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-08-13 10:44:16'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">90</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/img/archive_img.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Busyboxs</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">通过分析实例来理解TFRecord数据的读取与写入</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2018-09-04T04:00:00.000Z" title="发表于 2018-09-04 12:00:00">2018-09-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2019-08-13T02:44:16.627Z" title="更新于 2019-08-13 10:44:16">2019-08-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/tensorflow/">tensorflow</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="通过分析实例来理解TFRecord数据的读取与写入"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>本文主要通过两个实例来加强对TFRecord数据的理解，分别为目标检测算法SSD和语义分割算法deeplab。仅作为学习笔记以便后续查阅。</p>
</blockquote>
<h2 id="TFRecord简介"><a href="#TFRecord简介" class="headerlink" title="TFRecord简介"></a>TFRecord简介</h2><p><a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_guides/python/python_io">TFRecords文件</a>表示字符串序列（二进制文件）。其格式不是随机访问的，因此它适用于流式传输大量数据，但如果需要快速分片或其他非顺序访问则不适用。</p>
<p>TFRecords文件包含CRC32C（使用Castagnoli多项式的32位CRC）哈希值的字符串序列。每条记录都有以下格式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uint64 length</span><br><span class="line">uint32 masked_crc32_of_length</span><br><span class="line">byte   data[length]</span><br><span class="line">uint32 masked_crc32_of_data</span><br></pre></td></tr></table></figure>
<p>这些记录连接在一起以生成文件。更多CRC的描述参阅<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">这里</a>，CRC的掩码形式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">masked_crc = ((crc &gt;&gt; 15) | (crc &lt;&lt; 17)) + 0xa282ead8ul</span><br></pre></td></tr></table></figure>
<h2 id="SSD中TFRecord的使用"><a href="#SSD中TFRecord的使用" class="headerlink" title="SSD中TFRecord的使用"></a>SSD中TFRecord的使用</h2><p>SSD是一种目标检测方法。本节中使用到的代码主要来自于<a target="_blank" rel="noopener" href="https://github.com/balancap/SSD-Tensorflow">SSD-Tensorflow</a>。本节主要包括数据集的介绍，TFRecord数据写入，TFRecord数据读取。</p>
<h3 id="数据集介绍"><a href="#数据集介绍" class="headerlink" title="数据集介绍"></a>数据集介绍</h3><p>本节中主要使用VOC 2007数据集作为例子。具体下载方法请参考<a target="_blank" rel="noopener" href="https://github.com/rbgirshick/py-faster-rcnn">py-faster-rcnn</a>中的介绍。VOC2007具体文件结构如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">|---VOC2007</span><br><span class="line">    |---Annotations</span><br><span class="line">        |---000001.xml ~ 009963.xml</span><br><span class="line">    |---ImageSets</span><br><span class="line">        |---Layout</span><br><span class="line">            |---test.txt</span><br><span class="line">            |---train.txt</span><br><span class="line">            |---trainval.txt</span><br><span class="line">            |---val.txt</span><br><span class="line">        |---Main(每个类别都有对应的下列文件爱呢)</span><br><span class="line">            |---test.txt...</span><br><span class="line">            |---train.txt...</span><br><span class="line">            |---trainval.txt...</span><br><span class="line">            |---val.txt...</span><br><span class="line">        |---Segmentation</span><br><span class="line">            |---test.txt</span><br><span class="line">            |---train.txt</span><br><span class="line">            |---trainval.txt</span><br><span class="line">            |---val.txt</span><br><span class="line">    |---JPEGImages</span><br><span class="line">        |---000001.jpg ~ 009963.jpg</span><br><span class="line">    |---SegmentationClass</span><br><span class="line">        |---*.png(总共632张分割图)</span><br><span class="line">    |---SegmentationObject</span><br><span class="line">        |---*.png(总共632张分割图)</span><br></pre></td></tr></table></figure>
<p>Annotations对应于目标检测的标注，SegmentationClass和SegmentationObject对应于语义分割的标注。</p>
<p>Annotation中000005.xml的内容如下所示：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">annotation</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">folder</span>&gt;</span>VOC2007<span class="tag">&lt;/<span class="name">folder</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filename</span>&gt;</span>000001.jpg<span class="tag">&lt;/<span class="name">filename</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">database</span>&gt;</span>The VOC2007 Database<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">annotation</span>&gt;</span>PASCAL VOC2007<span class="tag">&lt;/<span class="name">annotation</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">image</span>&gt;</span>flickr<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">flickrid</span>&gt;</span>341012865<span class="tag">&lt;/<span class="name">flickrid</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">owner</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">flickrid</span>&gt;</span>Fried Camels<span class="tag">&lt;/<span class="name">flickrid</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>Jinky the Fruit Bat<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">owner</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">size</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">width</span>&gt;</span>353<span class="tag">&lt;/<span class="name">width</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">height</span>&gt;</span>500<span class="tag">&lt;/<span class="name">height</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">depth</span>&gt;</span>3<span class="tag">&lt;/<span class="name">depth</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">segmented</span>&gt;</span>0<span class="tag">&lt;/<span class="name">segmented</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">object</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>dog<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">pose</span>&gt;</span>Left<span class="tag">&lt;/<span class="name">pose</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">truncated</span>&gt;</span>1<span class="tag">&lt;/<span class="name">truncated</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">difficult</span>&gt;</span>0<span class="tag">&lt;/<span class="name">difficult</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">bndbox</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">xmin</span>&gt;</span>48<span class="tag">&lt;/<span class="name">xmin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ymin</span>&gt;</span>240<span class="tag">&lt;/<span class="name">ymin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">xmax</span>&gt;</span>195<span class="tag">&lt;/<span class="name">xmax</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ymax</span>&gt;</span>371<span class="tag">&lt;/<span class="name">ymax</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">bndbox</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">object</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>person<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">pose</span>&gt;</span>Left<span class="tag">&lt;/<span class="name">pose</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">truncated</span>&gt;</span>1<span class="tag">&lt;/<span class="name">truncated</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">difficult</span>&gt;</span>0<span class="tag">&lt;/<span class="name">difficult</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">bndbox</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">xmin</span>&gt;</span>8<span class="tag">&lt;/<span class="name">xmin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ymin</span>&gt;</span>12<span class="tag">&lt;/<span class="name">ymin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">xmax</span>&gt;</span>352<span class="tag">&lt;/<span class="name">xmax</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">ymax</span>&gt;</span>498<span class="tag">&lt;/<span class="name">ymax</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">bndbox</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">annotation</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里不对数据做过多介绍，具体请参阅官方网址。</p>
<h3 id="TFRecord数据写入"><a href="#TFRecord数据写入" class="headerlink" title="TFRecord数据写入"></a>TFRecord数据写入</h3><p>TFRecord构建的结构大致如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">                                                               |--&gt; tf.train.Feature </span><br><span class="line">                                                               |--&gt; tf.train.Feature</span><br><span class="line">tf.train.Example(features=) -&gt; tf.train.Features(feature=&#123;&#125;) --|         ...</span><br><span class="line">                                                               |--&gt; tf.train.Feature</span><br><span class="line">                                                               |--&gt; tf.train.Feature</span><br><span class="line">                   / tf.train.BytesList</span><br><span class="line">tf.train.Feature --  tf.train.Int64List</span><br><span class="line">                   \ tf.train.FloatList</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>用文字描述上面的结构大概是这样的。首先最外层是一个<code>tf.train.Example(features=)</code>类型，需要传一个<code>tf.train.Features(feature=&#123;&#125;)</code>类型的参数给features。而<code>tf.train.Features</code>需要传入一个字典类型给feature参数，字典key为保存数据序列的名称，value为一个<code>tf.train.BytesList</code>, <code>tf.train.Int64List</code>和<code>tf.train.FloatList</code>中的一种类型。这三种类型分别对应于string，integer和float类型的list数据。并且这三种类型含有共同的参数value，value需要传入的数据为对应类型的list数据。</p>
<h4 id="主要代码"><a href="#主要代码" class="headerlink" title="主要代码"></a>主要代码</h4><p>首先需要像写txt文件一样打开文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/busyboxs/SSD-Tensorflow/blob/master/datasets/pascalvoc_to_tfrecords.py#L210</span></span><br><span class="line"><span class="keyword">with</span> tf.python_io.TFRecordWriter(tf_filename) <span class="keyword">as</span> tfrecord_writer:</span><br></pre></td></tr></table></figure>
<p>以下代码对应3种类型的特征方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/busyboxs/SSD-Tensorflow/blob/master/datasets/dataset_utils.py#L30</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">int64_feature</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Wrapper for inserting int64 features into Example proto.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>):</span><br><span class="line">        value = [value]</span><br><span class="line">    <span class="keyword">return</span> tf.train.Feature(int64_list=tf.train.Int64List(value=value))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">float_feature</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Wrapper for inserting float features into Example proto.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>):</span><br><span class="line">        value = [value]</span><br><span class="line">    <span class="keyword">return</span> tf.train.Feature(float_list=tf.train.FloatList(value=value))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytes_feature</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Wrapper for inserting bytes features into Example proto.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">list</span>):</span><br><span class="line">        value = [value]</span><br><span class="line">    <span class="keyword">return</span> tf.train.Feature(bytes_list=tf.train.BytesList(value=value))</span><br></pre></td></tr></table></figure>
<p>以下程序主要是读取图像并解析相应的xml文件获取标注</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">https://github.com/busyboxs/SSD-Tensorflow/blob/master/datasets/pascalvoc_to_tfrecords.py<span class="comment">#L70</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_process_image</span>(<span class="params">directory, name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Process a image and annotation file.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      filename: string, path to an image file e.g., &#x27;/path/to/example.JPG&#x27;.</span></span><br><span class="line"><span class="string">      coder: instance of ImageCoder to provide TensorFlow image coding utils.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">      image_buffer: string, JPEG encoding of RGB image.</span></span><br><span class="line"><span class="string">      height: integer, image height in pixels.</span></span><br><span class="line"><span class="string">      width: integer, image width in pixels.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Read the image file.</span></span><br><span class="line">    filename = directory + DIRECTORY_IMAGES + name + <span class="string">&#x27;.jpg&#x27;</span></span><br><span class="line">    image_data = tf.gfile.FastGFile(filename, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read the XML annotation file.</span></span><br><span class="line">    filename = os.path.join(directory, DIRECTORY_ANNOTATIONS, name + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">    tree = ET.parse(filename)</span><br><span class="line">    root = tree.getroot()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Image shape.</span></span><br><span class="line">    size = root.find(<span class="string">&#x27;size&#x27;</span>)</span><br><span class="line">    shape = [<span class="built_in">int</span>(size.find(<span class="string">&#x27;height&#x27;</span>).text),</span><br><span class="line">             <span class="built_in">int</span>(size.find(<span class="string">&#x27;width&#x27;</span>).text),</span><br><span class="line">             <span class="built_in">int</span>(size.find(<span class="string">&#x27;depth&#x27;</span>).text)]</span><br><span class="line">    <span class="comment"># Find annotations.</span></span><br><span class="line">    bboxes = []</span><br><span class="line">    labels = []</span><br><span class="line">    labels_text = []</span><br><span class="line">    difficult = []</span><br><span class="line">    truncated = []</span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> root.findall(<span class="string">&#x27;object&#x27;</span>):</span><br><span class="line">        label = obj.find(<span class="string">&#x27;name&#x27;</span>).text</span><br><span class="line">        labels.append(<span class="built_in">int</span>(VOC_LABELS[label][<span class="number">0</span>]))</span><br><span class="line">        labels_text.append(label.encode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> obj.find(<span class="string">&#x27;difficult&#x27;</span>):</span><br><span class="line">            difficult.append(<span class="built_in">int</span>(obj.find(<span class="string">&#x27;difficult&#x27;</span>).text))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            difficult.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> obj.find(<span class="string">&#x27;truncated&#x27;</span>):</span><br><span class="line">            truncated.append(<span class="built_in">int</span>(obj.find(<span class="string">&#x27;truncated&#x27;</span>).text))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            truncated.append(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        bbox = obj.find(<span class="string">&#x27;bndbox&#x27;</span>)</span><br><span class="line">        bboxes.append((<span class="built_in">float</span>(bbox.find(<span class="string">&#x27;ymin&#x27;</span>).text) / shape[<span class="number">0</span>],</span><br><span class="line">                       <span class="built_in">float</span>(bbox.find(<span class="string">&#x27;xmin&#x27;</span>).text) / shape[<span class="number">1</span>],</span><br><span class="line">                       <span class="built_in">float</span>(bbox.find(<span class="string">&#x27;ymax&#x27;</span>).text) / shape[<span class="number">0</span>],</span><br><span class="line">                       <span class="built_in">float</span>(bbox.find(<span class="string">&#x27;xmax&#x27;</span>).text) / shape[<span class="number">1</span>]</span><br><span class="line">                       ))</span><br><span class="line">    <span class="keyword">return</span> image_data, shape, bboxes, labels, labels_text, difficult, truncated</span><br></pre></td></tr></table></figure>
<p>以下程序主要得到tf.train.Example</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/busyboxs/SSD-Tensorflow/blob/master/datasets/pascalvoc_to_tfrecords.py#L124</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_convert_to_example</span>(<span class="params">image_data, labels, labels_text, bboxes, shape,</span></span><br><span class="line"><span class="params">                        difficult, truncated</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Build an Example proto for an image example.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      image_data: string, JPEG encoding of RGB image;</span></span><br><span class="line"><span class="string">      labels: list of integers, identifier for the ground truth;</span></span><br><span class="line"><span class="string">      labels_text: list of strings, human-readable labels;</span></span><br><span class="line"><span class="string">      bboxes: list of bounding boxes; each box is a list of integers;</span></span><br><span class="line"><span class="string">          specifying [xmin, ymin, xmax, ymax]. All boxes are assumed to belong</span></span><br><span class="line"><span class="string">          to the same label as the image label.</span></span><br><span class="line"><span class="string">      shape: 3 integers, image shapes in pixels.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">      Example proto</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    xmin = []</span><br><span class="line">    ymin = []</span><br><span class="line">    xmax = []</span><br><span class="line">    ymax = []</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> bboxes:</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(b) == <span class="number">4</span></span><br><span class="line">        <span class="comment"># pylint: disable=expression-not-assigned</span></span><br><span class="line">        [l.append(point) <span class="keyword">for</span> l, point <span class="keyword">in</span> <span class="built_in">zip</span>([ymin, xmin, ymax, xmax], b)]</span><br><span class="line">        <span class="comment"># pylint: enable=expression-not-assigned</span></span><br><span class="line"></span><br><span class="line">    image_format = <span class="string">b&#x27;JPEG&#x27;</span></span><br><span class="line">    example = tf.train.Example(features=tf.train.Features(feature=&#123;</span><br><span class="line">            <span class="string">&#x27;image/height&#x27;</span>: int64_feature(shape[<span class="number">0</span>]),</span><br><span class="line">            <span class="string">&#x27;image/width&#x27;</span>: int64_feature(shape[<span class="number">1</span>]),</span><br><span class="line">            <span class="string">&#x27;image/channels&#x27;</span>: int64_feature(shape[<span class="number">2</span>]),</span><br><span class="line">            <span class="string">&#x27;image/shape&#x27;</span>: int64_feature(shape),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/xmin&#x27;</span>: float_feature(xmin),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/xmax&#x27;</span>: float_feature(xmax),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/ymin&#x27;</span>: float_feature(ymin),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/ymax&#x27;</span>: float_feature(ymax),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/label&#x27;</span>: int64_feature(labels),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/label_text&#x27;</span>: bytes_feature(labels_text),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/difficult&#x27;</span>: int64_feature(difficult),</span><br><span class="line">            <span class="string">&#x27;image/object/bbox/truncated&#x27;</span>: int64_feature(truncated),</span><br><span class="line">            <span class="string">&#x27;image/format&#x27;</span>: bytes_feature(image_format),</span><br><span class="line">            <span class="string">&#x27;image/encoded&#x27;</span>: bytes_feature(image_data)&#125;))</span><br><span class="line">    <span class="keyword">return</span> example</span><br></pre></td></tr></table></figure>
<p>为了便于理解，我将对应的feature函数还原，并只取前两个特征，这样代码就与上面介绍的结构相对应了。代码如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">example = tf.train.Example(features=tf.train.Features(feature=&#123;</span><br><span class="line">	<span class="string">&#x27;image/height&#x27;</span>: tf.train.Feature(int64_list=tf.train.Int64List(value=[shape[<span class="number">0</span>]])),</span><br><span class="line">	<span class="string">&#x27;image/width&#x27;</span>:tf.train.Feature(int64_list=tf.train.Int64List(value=[shape[<span class="number">1</span>]]))</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
<p>最后在写如TFRecord之前需要调用<code>SerializeToString</code>方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/busyboxs/SSD-Tensorflow/blob/master/datasets/pascalvoc_to_tfrecords.py#L180</span></span><br><span class="line">tfrecord_writer.write(example.SerializeToString())</span><br></pre></td></tr></table></figure>
<h3 id="TFRecord数据读取"><a href="#TFRecord数据读取" class="headerlink" title="TFRecord数据读取"></a>TFRecord数据读取</h3><p>在SSD的代码中，主要是使用slim模块来协助读取TFRecord的。主要代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/busyboxs/SSD-Tensorflow/blob/master/datasets/pascalvoc_common.py#L49</span></span><br><span class="line">reader = tf.TFRecordReader</span><br><span class="line"><span class="comment"># Features in Pascal VOC TFRecords.</span></span><br><span class="line">keys_to_features = &#123;</span><br><span class="line">	<span class="string">&#x27;image/encoded&#x27;</span>: tf.FixedLenFeature((), tf.string, default_value=<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;image/format&#x27;</span>: tf.FixedLenFeature((), tf.string, default_value=<span class="string">&#x27;jpeg&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;image/height&#x27;</span>: tf.FixedLenFeature([<span class="number">1</span>], tf.int64),</span><br><span class="line">	<span class="string">&#x27;image/width&#x27;</span>: tf.FixedLenFeature([<span class="number">1</span>], tf.int64),</span><br><span class="line">	<span class="string">&#x27;image/channels&#x27;</span>: tf.FixedLenFeature([<span class="number">1</span>], tf.int64),</span><br><span class="line">	<span class="string">&#x27;image/shape&#x27;</span>: tf.FixedLenFeature([<span class="number">3</span>], tf.int64),</span><br><span class="line">	<span class="string">&#x27;image/object/bbox/xmin&#x27;</span>: tf.VarLenFeature(dtype=tf.float32),</span><br><span class="line">	<span class="string">&#x27;image/object/bbox/ymin&#x27;</span>: tf.VarLenFeature(dtype=tf.float32),</span><br><span class="line">	<span class="string">&#x27;image/object/bbox/xmax&#x27;</span>: tf.VarLenFeature(dtype=tf.float32),</span><br><span class="line">	<span class="string">&#x27;image/object/bbox/ymax&#x27;</span>: tf.VarLenFeature(dtype=tf.float32),</span><br><span class="line">	<span class="string">&#x27;image/object/bbox/label&#x27;</span>: tf.VarLenFeature(dtype=tf.int64),</span><br><span class="line">	<span class="string">&#x27;image/object/bbox/difficult&#x27;</span>: tf.VarLenFeature(dtype=tf.int64),</span><br><span class="line">	<span class="string">&#x27;image/object/bbox/truncated&#x27;</span>: tf.VarLenFeature(dtype=tf.int64),</span><br><span class="line">&#125;</span><br><span class="line">items_to_handlers = &#123;</span><br><span class="line">	<span class="string">&#x27;image&#x27;</span>: slim.tfexample_decoder.Image(<span class="string">&#x27;image/encoded&#x27;</span>, <span class="string">&#x27;image/format&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;shape&#x27;</span>: slim.tfexample_decoder.Tensor(<span class="string">&#x27;image/shape&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;object/bbox&#x27;</span>: slim.tfexample_decoder.BoundingBox(</span><br><span class="line">			[<span class="string">&#x27;ymin&#x27;</span>, <span class="string">&#x27;xmin&#x27;</span>, <span class="string">&#x27;ymax&#x27;</span>, <span class="string">&#x27;xmax&#x27;</span>], <span class="string">&#x27;image/object/bbox/&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;object/label&#x27;</span>: slim.tfexample_decoder.Tensor(<span class="string">&#x27;image/object/bbox/label&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;object/difficult&#x27;</span>: slim.tfexample_decoder.Tensor(<span class="string">&#x27;image/object/bbox/difficult&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;object/truncated&#x27;</span>: slim.tfexample_decoder.Tensor(<span class="string">&#x27;image/object/bbox/truncated&#x27;</span>),</span><br><span class="line">&#125;</span><br><span class="line">decoder = slim.tfexample_decoder.TFExampleDecoder(</span><br><span class="line">	keys_to_features, items_to_handlers)</span><br><span class="line"></span><br><span class="line">dataset = slim.dataset.Dataset(</span><br><span class="line">		data_sources=file_pattern,</span><br><span class="line">		reader=reader,</span><br><span class="line">		decoder=decoder,</span><br><span class="line">		num_samples=split_to_sizes[split_name],</span><br><span class="line">		items_to_descriptions=items_to_descriptions,</span><br><span class="line">		num_classes=num_classes,</span><br><span class="line">		labels_to_names=labels_to_names)</span><br><span class="line"></span><br><span class="line">provider = slim.dataset_data_provider.DatasetDataProvider(</span><br><span class="line">                    dataset,</span><br><span class="line">                    num_readers=FLAGS.num_readers,</span><br><span class="line">                    common_queue_capacity=<span class="number">20</span> * FLAGS.batch_size,</span><br><span class="line">                    common_queue_min=<span class="number">10</span> * FLAGS.batch_size,</span><br><span class="line">                    shuffle=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># Get for SSD network: image, labels, bboxes.</span></span><br><span class="line">[image, shape, glabels, gbboxes] = provider.get([<span class="string">&#x27;image&#x27;</span>, <span class="string">&#x27;shape&#x27;</span>, <span class="string">&#x27;object/label&#x27;</span>, <span class="string">&#x27;object/bbox&#x27;</span>])</span><br></pre></td></tr></table></figure>
<p>其中TFExampleDecoder的定义如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/tensorflow/tensorflow/blob/r1.10/tensorflow/contrib/slim/python/slim/data/tfexample_decoder.py#L455</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TFExampleDecoder</span>(data_decoder.DataDecoder):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;A decoder for TensorFlow Examples.</span></span><br><span class="line"><span class="string">  Decoding Example proto buffers is comprised of two stages: (1) Example parsing</span></span><br><span class="line"><span class="string">  and (2) tensor manipulation.</span></span><br><span class="line"><span class="string">  In the first stage, the tf.parse_example function is called with a list of</span></span><br><span class="line"><span class="string">  FixedLenFeatures and SparseLenFeatures. These instances tell TF how to parse</span></span><br><span class="line"><span class="string">  the example. The output of this stage is a set of tensors.</span></span><br><span class="line"><span class="string">  In the second stage, the resulting tensors are manipulated to provide the</span></span><br><span class="line"><span class="string">  requested &#x27;item&#x27; tensors.</span></span><br><span class="line"><span class="string">  To perform this decoding operation, an ExampleDecoder is given a list of</span></span><br><span class="line"><span class="string">  ItemHandlers. Each ItemHandler indicates the set of features for stage 1 and</span></span><br><span class="line"><span class="string">  contains the instructions for post_processing its tensors for stage 2.</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, keys_to_features, items_to_handlers</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs the decoder.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      keys_to_features: a dictionary from TF-Example keys to either</span></span><br><span class="line"><span class="string">        tf.VarLenFeature or tf.FixedLenFeature instances. See tensorflow&#x27;s</span></span><br><span class="line"><span class="string">        parsing_ops.py.</span></span><br><span class="line"><span class="string">      items_to_handlers: a dictionary from items (strings) to ItemHandler</span></span><br><span class="line"><span class="string">        instances. Note that the ItemHandler&#x27;s are provided the keys that they</span></span><br><span class="line"><span class="string">        use to return the final item Tensors.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self._keys_to_features = keys_to_features</span><br><span class="line">    self._items_to_handlers = items_to_handlers</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">list_items</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;See base class.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>(self._items_to_handlers.keys())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">self, serialized_example, items=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Decodes the given serialized TF-example.</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      serialized_example: a serialized TF-example tensor.</span></span><br><span class="line"><span class="string">      items: the list of items to decode. These must be a subset of the item</span></span><br><span class="line"><span class="string">        keys in self._items_to_handlers. If `items` is left as None, then all</span></span><br><span class="line"><span class="string">        of the items in self._items_to_handlers are decoded.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">      the decoded items, a list of tensor.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    example = parsing_ops.parse_single_example(serialized_example,</span><br><span class="line">                                               self._keys_to_features)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Reshape non-sparse elements just once, adding the reshape ops in</span></span><br><span class="line">    <span class="comment"># deterministic order.</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">sorted</span>(self._keys_to_features):</span><br><span class="line">      v = self._keys_to_features[k]</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">isinstance</span>(v, parsing_ops.FixedLenFeature):</span><br><span class="line">        example[k] = array_ops.reshape(example[k], v.shape)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> items:</span><br><span class="line">      items = self._items_to_handlers.keys()</span><br><span class="line"></span><br><span class="line">    outputs = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">      handler = self._items_to_handlers[item]</span><br><span class="line">      keys_to_tensors = &#123;key: example[key] <span class="keyword">for</span> key <span class="keyword">in</span> handler.keys&#125;</span><br><span class="line">      outputs.append(handler.tensors_to_item(keys_to_tensors))</span><br><span class="line">    <span class="keyword">return</span> outputs</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>decode</code>方法中<code>example = parsing_ops.parse_single_example(serialized_example, self._keys_to_features)</code>便是解析TFRecord数据。decode方法主要在<code>slim.dataset_data_provider.DatasetDataProvider</code>被调用，详情见<a target="_blank" rel="noopener" href="https://github.com/tensorflow/tensorflow/blob/r1.10/tensorflow/contrib/slim/python/slim/data/dataset_data_provider.py#L99">这里</a>。</p>
<h2 id="deeplab中TFRecord的使用"><a href="#deeplab中TFRecord的使用" class="headerlink" title="deeplab中TFRecord的使用"></a>deeplab中TFRecord的使用</h2><h3 id="TFReccord写入"><a href="#TFReccord写入" class="headerlink" title="TFReccord写入"></a>TFReccord写入</h3><p>主要代码如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/tensorflow/models/blob/master/research/deeplab/datasets/build_data.py#L105</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_int64_list_feature</span>(<span class="params">values</span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;Returns a TF-Feature of int64_list.</span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">    values: A scalar or list of values.</span></span><br><span class="line"><span class="string">  Returns:</span></span><br><span class="line"><span class="string">    A TF-Feature.</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(values, collections.Iterable):</span><br><span class="line">    values = [values]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tf.train.Feature(int64_list=tf.train.Int64List(value=values))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_bytes_list_feature</span>(<span class="params">values</span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;Returns a TF-Feature of bytes.</span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">    values: A string.</span></span><br><span class="line"><span class="string">  Returns:</span></span><br><span class="line"><span class="string">    A TF-Feature.</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">norm2bytes</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="keyword">return</span> value.encode() <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>) <span class="keyword">and</span> six.PY3 <span class="keyword">else</span> value</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tf.train.Feature(</span><br><span class="line">      bytes_list=tf.train.BytesList(value=[norm2bytes(values)]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">image_seg_to_tfexample</span>(<span class="params">image_data, filename, height, width, seg_data</span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;Converts one image/segmentation pair to tf example.</span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">    image_data: string of image data.</span></span><br><span class="line"><span class="string">    filename: image filename.</span></span><br><span class="line"><span class="string">    height: image height.</span></span><br><span class="line"><span class="string">    width: image width.</span></span><br><span class="line"><span class="string">    seg_data: string of semantic segmentation data.</span></span><br><span class="line"><span class="string">  Returns:</span></span><br><span class="line"><span class="string">    tf example of one image/segmentation pair.</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">return</span> tf.train.Example(features=tf.train.Features(feature=&#123;</span><br><span class="line">      <span class="string">&#x27;image/encoded&#x27;</span>: _bytes_list_feature(image_data),</span><br><span class="line">      <span class="string">&#x27;image/filename&#x27;</span>: _bytes_list_feature(filename),</span><br><span class="line">      <span class="string">&#x27;image/format&#x27;</span>: _bytes_list_feature(</span><br><span class="line">          _IMAGE_FORMAT_MAP[FLAGS.image_format]),</span><br><span class="line">      <span class="string">&#x27;image/height&#x27;</span>: _int64_list_feature(height),</span><br><span class="line">      <span class="string">&#x27;image/width&#x27;</span>: _int64_list_feature(width),</span><br><span class="line">      <span class="string">&#x27;image/channels&#x27;</span>: _int64_list_feature(<span class="number">3</span>),</span><br><span class="line">      <span class="string">&#x27;image/segmentation/class/encoded&#x27;</span>: (</span><br><span class="line">          _bytes_list_feature(seg_data)),</span><br><span class="line">      <span class="string">&#x27;image/segmentation/class/format&#x27;</span>: _bytes_list_feature(</span><br><span class="line">          FLAGS.label_format),</span><br><span class="line">  &#125;))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/tensorflow/models/blob/master/research/deeplab/datasets/build_voc2012_data.py#L84</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_convert_dataset</span>(<span class="params">dataset_split</span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;Converts the specified dataset split to TFRecord format.</span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">    dataset_split: The dataset split (e.g., train, test).</span></span><br><span class="line"><span class="string">  Raises:</span></span><br><span class="line"><span class="string">    RuntimeError: If loaded image and label have different shape.</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  dataset = os.path.basename(dataset_split)[:-<span class="number">4</span>]</span><br><span class="line">  sys.stdout.write(<span class="string">&#x27;Processing &#x27;</span> + dataset)</span><br><span class="line">  filenames = [x.strip(<span class="string">&#x27;\n&#x27;</span>) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">open</span>(dataset_split, <span class="string">&#x27;r&#x27;</span>)]</span><br><span class="line">  num_images = <span class="built_in">len</span>(filenames)</span><br><span class="line">  num_per_shard = <span class="built_in">int</span>(math.ceil(num_images / <span class="built_in">float</span>(_NUM_SHARDS)))</span><br><span class="line"></span><br><span class="line">  image_reader = build_data.ImageReader(<span class="string">&#x27;jpeg&#x27;</span>, channels=<span class="number">3</span>)</span><br><span class="line">  label_reader = build_data.ImageReader(<span class="string">&#x27;png&#x27;</span>, channels=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> shard_id <span class="keyword">in</span> <span class="built_in">range</span>(_NUM_SHARDS):</span><br><span class="line">    output_filename = os.path.join(</span><br><span class="line">        FLAGS.output_dir,</span><br><span class="line">        <span class="string">&#x27;%s-%05d-of-%05d.tfrecord&#x27;</span> % (dataset, shard_id, _NUM_SHARDS))</span><br><span class="line">    <span class="keyword">with</span> tf.python_io.TFRecordWriter(output_filename) <span class="keyword">as</span> tfrecord_writer:</span><br><span class="line">      start_idx = shard_id * num_per_shard</span><br><span class="line">      end_idx = <span class="built_in">min</span>((shard_id + <span class="number">1</span>) * num_per_shard, num_images)</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start_idx, end_idx):</span><br><span class="line">        sys.stdout.write(<span class="string">&#x27;\r&gt;&gt; Converting image %d/%d shard %d&#x27;</span> % (</span><br><span class="line">            i + <span class="number">1</span>, <span class="built_in">len</span>(filenames), shard_id))</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        <span class="comment"># Read the image.</span></span><br><span class="line">        image_filename = os.path.join(</span><br><span class="line">            FLAGS.image_folder, filenames[i] + <span class="string">&#x27;.&#x27;</span> + FLAGS.image_format)</span><br><span class="line">        image_data = tf.gfile.FastGFile(image_filename, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">        height, width = image_reader.read_image_dims(image_data)</span><br><span class="line">        <span class="comment"># Read the semantic segmentation annotation.</span></span><br><span class="line">        seg_filename = os.path.join(</span><br><span class="line">            FLAGS.semantic_segmentation_folder,</span><br><span class="line">            filenames[i] + <span class="string">&#x27;.&#x27;</span> + FLAGS.label_format)</span><br><span class="line">        seg_data = tf.gfile.FastGFile(seg_filename, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">        seg_height, seg_width = label_reader.read_image_dims(seg_data)</span><br><span class="line">        <span class="keyword">if</span> height != seg_height <span class="keyword">or</span> width != seg_width:</span><br><span class="line">          <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Shape mismatched between image and label.&#x27;</span>)</span><br><span class="line">        <span class="comment"># Convert to tf example.</span></span><br><span class="line">		<span class="comment"># 关键代码是下面两行代码</span></span><br><span class="line">        example = build_data.image_seg_to_tfexample(</span><br><span class="line">            image_data, filenames[i], height, width, seg_data)</span><br><span class="line">        tfrecord_writer.write(example.SerializeToString())</span><br><span class="line">    sys.stdout.write(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    sys.stdout.flush()</span><br></pre></td></tr></table></figure>
<h3 id="TFRecord读取"><a href="#TFRecord读取" class="headerlink" title="TFRecord读取"></a>TFRecord读取</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/tensorflow/models/blob/master/research/deeplab/datasets/segmentation_dataset.py#L156</span></span><br><span class="line"><span class="comment"># Specify how the TF-Examples are decoded.</span></span><br><span class="line">keys_to_features = &#123;</span><br><span class="line">	<span class="string">&#x27;image/encoded&#x27;</span>: tf.FixedLenFeature(</span><br><span class="line">		(), tf.string, default_value=<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;image/filename&#x27;</span>: tf.FixedLenFeature(</span><br><span class="line">		(), tf.string, default_value=<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;image/format&#x27;</span>: tf.FixedLenFeature(</span><br><span class="line">		(), tf.string, default_value=<span class="string">&#x27;jpeg&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;image/height&#x27;</span>: tf.FixedLenFeature(</span><br><span class="line">		(), tf.int64, default_value=<span class="number">0</span>),</span><br><span class="line">	<span class="string">&#x27;image/width&#x27;</span>: tf.FixedLenFeature(</span><br><span class="line">		(), tf.int64, default_value=<span class="number">0</span>),</span><br><span class="line">	<span class="string">&#x27;image/segmentation/class/encoded&#x27;</span>: tf.FixedLenFeature(</span><br><span class="line">		(), tf.string, default_value=<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;image/segmentation/class/format&#x27;</span>: tf.FixedLenFeature(</span><br><span class="line">		(), tf.string, default_value=<span class="string">&#x27;png&#x27;</span>),</span><br><span class="line">&#125;</span><br><span class="line">items_to_handlers = &#123;</span><br><span class="line">	<span class="string">&#x27;image&#x27;</span>: tfexample_decoder.Image(</span><br><span class="line">		image_key=<span class="string">&#x27;image/encoded&#x27;</span>,</span><br><span class="line">		format_key=<span class="string">&#x27;image/format&#x27;</span>,</span><br><span class="line">		channels=<span class="number">3</span>),</span><br><span class="line">	<span class="string">&#x27;image_name&#x27;</span>: tfexample_decoder.Tensor(<span class="string">&#x27;image/filename&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;height&#x27;</span>: tfexample_decoder.Tensor(<span class="string">&#x27;image/height&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;width&#x27;</span>: tfexample_decoder.Tensor(<span class="string">&#x27;image/width&#x27;</span>),</span><br><span class="line">	<span class="string">&#x27;labels_class&#x27;</span>: tfexample_decoder.Image(</span><br><span class="line">		image_key=<span class="string">&#x27;image/segmentation/class/encoded&#x27;</span>,</span><br><span class="line">		format_key=<span class="string">&#x27;image/segmentation/class/format&#x27;</span>,</span><br><span class="line">		channels=<span class="number">1</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">decoder = tfexample_decoder.TFExampleDecoder(</span><br><span class="line">	keys_to_features, items_to_handlers)</span><br><span class="line"></span><br><span class="line">dataset = dataset.Dataset(</span><br><span class="line">      data_sources=file_pattern,</span><br><span class="line">      reader=tf.TFRecordReader,</span><br><span class="line">      decoder=decoder,</span><br><span class="line">      num_samples=splits_to_sizes[split_name],</span><br><span class="line">      items_to_descriptions=_ITEMS_TO_DESCRIPTIONS,</span><br><span class="line">      ignore_label=ignore_label,</span><br><span class="line">      num_classes=num_classes,</span><br><span class="line">      name=dataset_name,</span><br><span class="line">      multi_label=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>然后通过 input_genetator调用dataset</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/tensorflow/models/blob/master/research/deeplab/train.py#L253</span></span><br><span class="line">samples = input_generator.get(</span><br><span class="line">          dataset,</span><br><span class="line">          FLAGS.train_crop_size,</span><br><span class="line">          clone_batch_size,</span><br><span class="line">          min_resize_value=FLAGS.min_resize_value,</span><br><span class="line">          max_resize_value=FLAGS.max_resize_value,</span><br><span class="line">          resize_factor=FLAGS.resize_factor,</span><br><span class="line">          min_scale_factor=FLAGS.min_scale_factor,</span><br><span class="line">          max_scale_factor=FLAGS.max_scale_factor,</span><br><span class="line">          scale_factor_step_size=FLAGS.scale_factor_step_size,</span><br><span class="line">          dataset_split=FLAGS.train_split,</span><br><span class="line">          is_training=<span class="literal">True</span>,</span><br><span class="line">          model_variant=FLAGS.model_variant)</span><br><span class="line">      inputs_queue = prefetch_queue.prefetch_queue(</span><br><span class="line">          samples, capacity=<span class="number">128</span> * config.num_clones)</span><br></pre></td></tr></table></figure>
<p>而在input_generator的get方法中，通过<code>dataset_data_provider.DatasetDataProvider</code>调用dataset，这里就和VOC 2007中的描述一样了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/tensorflow/models/blob/master/research/deeplab/utils/input_generator.py</span></span><br><span class="line">data_provider = dataset_data_provider.DatasetDataProvider(</span><br><span class="line">	dataset,</span><br><span class="line">	num_readers=num_readers,</span><br><span class="line">	num_epochs=<span class="literal">None</span> <span class="keyword">if</span> is_training <span class="keyword">else</span> <span class="number">1</span>,</span><br><span class="line">	shuffle=is_training)</span><br><span class="line">image, label, image_name, height, width = _get_data(data_provider, dataset_split)</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://busyboxs.github.io">Busyboxs</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://busyboxs.github.io/blogs/97eeec88/">https://busyboxs.github.io/blogs/97eeec88/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://busyboxs.github.io" target="_blank">Busyboxs</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/tensorflow/">tensorflow</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blogs/f77e32b8/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">TFRecord 是什么？如何使用?</div></div></a></div><div class="next-post pull-right"><a href="/blogs/7bde1198/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【译】Tensorflow 与 Keras？通过构建图像分类模型来比较</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/blogs/7bde1198/" title="【译】Tensorflow 与 Keras？通过构建图像分类模型来比较"><img class="cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-09-14</div><div class="title">【译】Tensorflow 与 Keras？通过构建图像分类模型来比较</div></div></a></div><div><a href="/blogs/f77e32b8/" title="TFRecord 是什么？如何使用?"><img class="cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-08-26</div><div class="title">TFRecord 是什么？如何使用?</div></div></a></div><div><a href="/blogs/fe533d02/" title="tensorflow学习笔记（1）：TENSORFLOW&#39;S HELLO WORLD"><img class="cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-08-11</div><div class="title">tensorflow学习笔记（1）：TENSORFLOW&#39;S HELLO WORLD</div></div></a></div><div><a href="/blogs/233b154a/" title="tensorflow学习笔记（3）：LOGISTIC REGRESSION WITH TENSORFLOW"><img class="cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-08-27</div><div class="title">tensorflow学习笔记（3）：LOGISTIC REGRESSION WITH TENSORFLOW</div></div></a></div><div><a href="/blogs/94e07831/" title="tensorflow学习笔记（2）：LINEAR REGRESSION WITH TENSORFLOW"><img class="cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-08-27</div><div class="title">tensorflow学习笔记（2）：LINEAR REGRESSION WITH TENSORFLOW</div></div></a></div><div><a href="/blogs/2b14ee1d/" title="tensorflow学习笔记（4）：Activation Functions"><img class="cover" src="https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/covers/tensorflow.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2017-08-27</div><div class="title">tensorflow学习笔记（4）：Activation Functions</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TFRecord%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">TFRecord简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSD%E4%B8%ADTFRecord%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">SSD中TFRecord的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">数据集介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TFRecord%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5"><span class="toc-number">2.2.</span> <span class="toc-text">TFRecord数据写入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.1.</span> <span class="toc-text">主要代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TFRecord%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96"><span class="toc-number">2.3.</span> <span class="toc-text">TFRecord数据读取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deeplab%E4%B8%ADTFRecord%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">deeplab中TFRecord的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TFReccord%E5%86%99%E5%85%A5"><span class="toc-number">3.1.</span> <span class="toc-text">TFReccord写入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TFRecord%E8%AF%BB%E5%8F%96"><span class="toc-number">3.2.</span> <span class="toc-text">TFRecord读取</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/busyboxs/CDN@latest/img/archive_img.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2022 By Busyboxs</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">❤🦋Stay foolish. Stay hungry.🦋❤</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="爱你哟,好好学习，天天向上,Stay hungry. Stay foolish.,✨✨✨,🎈🎈🎈,🎮🎮,♥♥♥♥,🏐🏐,🪂🪂" data-fontsize="10px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>